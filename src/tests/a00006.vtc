varnishtest "SOAP: req body is not in XML format."

varnish v1 -vcl {
    import ${vmod_soap};
    import std;

    backend foo none;

    sub vcl_recv
    {
            # cache just enough to determine if xml
            std.cache_req_body(10B, partial=true);
            if(soap.is_valid()) {
                    set req.http.soap-ws-ns = soap.action_namespace();
                    return (synth(200));
            }
            else {
                    return (synth(400, "Wrong SOAP message"));
            }
    }
} -start

client c1 {
        timeout 8
        txreq -req POST -body {<html>fake xml</html>}
        rxresp
        expect resp.status == 400

        txreq -req POST -body {<?xml version="1.0" encoding="utf-8"?>
        <Envelope xmlns="http://schemas.xmlsoap.org/soap/envelope/">
        <Body><Test xmlns="http://schemas.reuters.com/mytest"/></Body>
        </Envelope>}
        rxresp
        expect resp.status == 200
} -run
